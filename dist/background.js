import{C as R,a as p,L as m,U as E,b as S,S as r,A as w,R as T}from"./assets/routers-80mQZLFW.js";const d=Object.freeze({GLOBAL_MODE:"global-mode",SEPARATOR:"separator",REBOOT:"reboot-extension"}),A=Object.freeze({CALL_BUTTON:"/web/dataset/call_button",READ_WIZARD:"/web/dataset/call_kw/mts.router.switch.command.wizard/read",CREATE_WIZARD:"/web/dataset/call_kw/mts.router.switch.command.wizard/create"}),_=()=>Math.floor(Math.random()*1e9),C=t=>({bin_size:!0,lang:m.LANG,tz:m.TZ,uid:p,allowed_company_ids:[...R],full_width:!0,default_mts_router_switch_id:parseInt(t.id,10),default_mts_router_switch_name:t.name});async function f(t,e,a){const s=await(await fetch(`${E}${t}`,{method:"POST",headers:{"Content-Type":"application/json",Cookie:`session_id=${a}`},body:JSON.stringify(e),credentials:"include"})).json();if(s.error)throw new Error(s.error.message||"API Error");return s}async function O(t,e){const a=C(t),o={jsonrpc:"2.0",method:"call",params:{args:[{mts_router_switch_id:parseInt(t.id,10),interface:"GigabitEthernet"}],model:"mts.router.switch.command.wizard",method:"create",kwargs:{context:a}},id:_()},i=(await f(A.CREATE_WIZARD,o,e)).result;if(!i)throw new Error("Failed to create wizard");const c={jsonrpc:"2.0",method:"call",params:{args:[[i]],model:"mts.router.switch.command.wizard",method:"action_log",kwargs:{context:{lang:m.LANG,tz:m.TZ,uid:p,allowed_company_ids:[...R],full_width:!0,active_model:"mts.router.switch.command.wizard",active_id:i,active_ids:[i]}}},id:_()};await f(A.CALL_BUTTON,c,e);const n={jsonrpc:"2.0",method:"call",params:{args:[[i],["mts_router_switch_id","interface","output"]],model:"mts.router.switch.command.wizard",method:"read",kwargs:{context:a}},id:_()};return f(A.READ_WIZARD,n,e)}const g=Object.freeze({ALARM_ID:"0x0813005b",CLEAR_TYPE:"service_resume"}),h=Object.freeze({PORT:/(\d+\/\d+\/\d+)\s*$/,DATE:/^(\w{3}\s+\d{1,2}\s+\d{4}\s+\d{1,2}:\d{2})/,BR_TAG:/<br\s*\/?>/gi,HTML_TAG:/<[^>]+>/g}),k="<p><br></p>";function x(t){return t.replace(h.BR_TAG,`
`).replace(h.HTML_TAG,"").split(`
`).map(e=>e.trim()).filter(Boolean)}function j(t){if(!t.includes(`alarmID=${g.ALARM_ID}`))return null;const o=t.includes(`clearType=${g.CLEAR_TYPE}`),s=t.match(h.PORT),i=s?s[1]:null;if(!i)return null;const c=t.match(h.DATE);let n=null;if(c){const l=new Date(c[1]);isNaN(l.getTime())||(n=l.getTime())}return{state:o?"UP":"DOWN",port:i,timestamp:n,date:n?new Date(n).toISOString():null,raw:t}}function D(t,e){const a=Array.isArray(t==null?void 0:t.result)?t.result:[],o={};let s=0;for(const c of a){const n=c==null?void 0:c.output;if(!n||n===k)continue;const l=x(n);for(const U of l){const u=j(U);u&&(o[u.port]||(o[u.port]=[]),o[u.port].push(u),s++)}}for(const c of Object.keys(o))o[c].sort((n,l)=>(l.timestamp||0)-(n.timestamp||0));const i=Object.values(o).some(c=>{var n;return!c||c.length===0?!1:((n=c[0])==null?void 0:n.state)==="DOWN"});return{routerId:e.id,routerName:e.name,ports:o,totalEvents:s,affectedPorts:Object.keys(o).length,hasIssues:i,lastUpdated:Date.now()}}async function y(){const t=await chrome.storage.local.get(Object.keys(S)),e={};for(const[a,o]of Object.entries(S))t[a]===void 0&&(e[a]=o);Object.keys(e).length>0&&await chrome.storage.local.set(e)}async function G(){const t=await chrome.storage.local.get(null);return{schedulerEnabled:t[r.SCHEDULER_ENABLED]??!1,schedulerFrequency:t[r.SCHEDULER_FREQUENCY]??60,schedulerStartTime:t.schedulerStartTime??null,sessionId:t[r.SESSION_ID],routerData:t[r.ROUTER_DATA]??{},lastCheck:t[r.LAST_CHECK],authState:t[r.AUTH_STATE]??"unknown",routers:T}}async function z(t,e){const a={[r.SCHEDULER_ENABLED]:t,[r.SCHEDULER_FREQUENCY]:e,schedulerStartTime:t?Date.now():null};return await chrome.storage.local.set(a),await chrome.alarms.clear(w),t&&e&&await chrome.alarms.create(w,{periodInMinutes:e,delayInMinutes:e}),{success:!0,schedulerStartTime:a.schedulerStartTime}}async function B(t){return await chrome.storage.local.set({[r.SESSION_ID]:t}),{success:!0}}async function v(t){const e=t?"logged_in":"logged_out";return await chrome.storage.local.set({[r.AUTH_STATE]:e}),t||await chrome.storage.local.set({[r.SESSION_ID]:null}),{success:!0,authState:e}}async function H(t,e){const{[r.ROUTER_DATA]:a}=await chrome.storage.local.get(r.ROUTER_DATA);return a!=null&&a[t]&&(a[t].lastSeenState=e,await chrome.storage.local.set({[r.ROUTER_DATA]:a})),{success:!0}}async function I(){return await chrome.alarms.clearAll(),await chrome.storage.local.clear(),await y(),{success:!0}}async function F(){try{const e=(await chrome.cookies.getAll({domain:"nocportal.telekom.rs"})).find(a=>a.name==="session_id");if(e!=null&&e.value)return await chrome.storage.local.set({[r.SESSION_ID]:e.value}),e.value}catch{}return null}async function L(){let{[r.SESSION_ID]:t}=await chrome.storage.local.get(r.SESSION_ID);return t||(t=await F()),t}function b(t,e){if(!(t!=null&&t.ports)||!(e!=null&&e.ports))return Object.keys((e==null?void 0:e.ports)||{}).length>0;const a=t.ports,o=e.ports;for(const s of Object.keys(o))if(!a[s]||o[s].length>a[s].length)return!0;return!1}async function W(t,e){const{[r.ROUTER_DATA]:a={}}=await chrome.storage.local.get(r.ROUTER_DATA),o=a[t];return(o==null?void 0:o.lastSeenState)==="seen"&&!b(o,e)&&(e.lastSeenState="seen"),a[t]=e,await chrome.storage.local.set({[r.ROUTER_DATA]:a,[r.LAST_CHECK]:Date.now()}),a}async function N(){const t=await L();if(!t)return{error:"No session - open NOC Portal first"};for(const a of T){await chrome.storage.local.set({scanningRouter:a.name});const{[r.ROUTER_DATA]:o={}}=await chrome.storage.local.get(r.ROUTER_DATA),s=o[a.id];let i;try{const n=await O(a,t);i=D(n,a),(s==null?void 0:s.lastSeenState)==="seen"&&!b(s,i)&&(i.lastSeenState="seen")}catch(n){i={error:n.message}}const{[r.ROUTER_DATA]:c={}}=await chrome.storage.local.get(r.ROUTER_DATA);c[a.id]=i,await chrome.storage.local.set({[r.ROUTER_DATA]:c,[r.LAST_CHECK]:Date.now()})}await chrome.storage.local.remove("scanningRouter");const{[r.ROUTER_DATA]:e={}}=await chrome.storage.local.get(r.ROUTER_DATA);return{success:!0,results:e}}async function Y(t){const e=await L();if(!e)return{error:"No session - open NOC Portal first"};const a=T.find(o=>o.id===t);if(!a)return{error:"Router not found"};try{const o=await O(a,e),s=D(o,a);return await W(a.id,s),{success:!0,result:s}}catch(o){return{error:o.message}}}chrome.runtime.onInstalled.addListener(async()=>{await y(),await chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}),await $()});async function $(){await chrome.contextMenus.removeAll();const{[r.SIDE_PANEL_MODE]:t}=await chrome.storage.sync.get(r.SIDE_PANEL_MODE);chrome.contextMenus.create({id:d.GLOBAL_MODE,title:"Global mode",type:"checkbox",checked:t||!1,contexts:["action"]}),chrome.contextMenus.create({id:d.SEPARATOR,type:"separator",contexts:["action"]}),chrome.contextMenus.create({id:d.REBOOT,title:"Reboot extension",type:"normal",contexts:["action"]})}chrome.contextMenus.onClicked.addListener(async t=>{t.menuItemId===d.GLOBAL_MODE?(await chrome.storage.sync.set({[r.SIDE_PANEL_MODE]:t.checked}),await P()):t.menuItemId===d.REBOOT&&await I()});chrome.alarms.onAlarm.addListener(async t=>{t.name===w&&await N()});async function M(t,e){const{[r.SIDE_PANEL_MODE]:a}=await chrome.storage.sync.get(r.SIDE_PANEL_MODE);try{await chrome.sidePanel.setOptions({tabId:t,path:"app/index.html",enabled:a||e})}catch{}}async function P(){const{[r.SIDE_PANEL_MODE]:t}=await chrome.storage.sync.get(r.SIDE_PANEL_MODE),e=await chrome.tabs.query({url:`${E}/*`}),a=new Set(e.map(s=>s.id)),o=await chrome.tabs.query({});for(const s of o)if(s.id)try{await chrome.sidePanel.setOptions({tabId:s.id,path:"app/index.html",enabled:t||a.has(s.id)})}catch{}}chrome.tabs.onActivated.addListener(async t=>{var e;try{const o=((e=(await chrome.tabs.get(t.tabId)).url)==null?void 0:e.startsWith(E))||!1;await M(t.tabId,o)}catch{}});chrome.tabs.onUpdated.addListener(async(t,e)=>{if(e.url){const a=e.url.startsWith(E);await M(t,a)}});chrome.runtime.onMessage.addListener((t,e,a)=>(Z(t).then(a),!0));async function Z(t){switch(t.action){case"getState":return G();case"setScheduler":return z(t.enabled,t.frequency);case"fetchAll":return N();case"fetchRouter":return Y(t.routerId);case"reboot":return I();case"sessionDetected":return B(t.sessionId);case"authStateChanged":return v(t.isLoggedIn);case"updateRouterSeen":return H(t.routerId,t.lastSeenState);case"setGlobalMode":return await chrome.storage.sync.set({[r.SIDE_PANEL_MODE]:t.globalMode}),await P(),{success:!0};case"getGlobalMode":return{globalMode:(await chrome.storage.sync.get(r.SIDE_PANEL_MODE))[r.SIDE_PANEL_MODE]||!1};default:return{error:"Unknown action"}}}
