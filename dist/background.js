import{C as R,a as p,L as m,U as E,b as T,S as o,A as w,R as S}from"./assets/routers-80mQZLFW.js";const d=Object.freeze({GLOBAL_MODE:"global-mode",SEPARATOR:"separator",REBOOT:"reboot-extension"}),_=Object.freeze({CALL_BUTTON:"/web/dataset/call_button",READ_WIZARD:"/web/dataset/call_kw/mts.router.switch.command.wizard/read",CREATE_WIZARD:"/web/dataset/call_kw/mts.router.switch.command.wizard/create"}),A=()=>Math.floor(Math.random()*1e9),U=t=>({bin_size:!0,lang:m.LANG,tz:m.TZ,uid:p,allowed_company_ids:[...R],full_width:!0,default_mts_router_switch_id:parseInt(t.id,10),default_mts_router_switch_name:t.name});async function f(t,e,a){const s=await(await fetch(`${E}${t}`,{method:"POST",headers:{"Content-Type":"application/json",Cookie:`session_id=${a}`},body:JSON.stringify(e),credentials:"include"})).json();if(s.error)throw new Error(s.error.message||"API Error");return s}async function O(t,e){const a=U(t),r={jsonrpc:"2.0",method:"call",params:{args:[{mts_router_switch_id:parseInt(t.id,10),interface:"GigabitEthernet"}],model:"mts.router.switch.command.wizard",method:"create",kwargs:{context:a}},id:A()},i=(await f(_.CREATE_WIZARD,r,e)).result;if(!i)throw new Error("Failed to create wizard");const n={jsonrpc:"2.0",method:"call",params:{args:[[i]],model:"mts.router.switch.command.wizard",method:"action_log",kwargs:{context:{lang:m.LANG,tz:m.TZ,uid:p,allowed_company_ids:[...R],full_width:!0,active_model:"mts.router.switch.command.wizard",active_id:i,active_ids:[i]}}},id:A()};await f(_.CALL_BUTTON,n,e);const c={jsonrpc:"2.0",method:"call",params:{args:[[i],["mts_router_switch_id","interface","output"]],model:"mts.router.switch.command.wizard",method:"read",kwargs:{context:a}},id:A()};return f(_.READ_WIZARD,c,e)}const g=Object.freeze({ALARM_ID:"0x0813005b",CLEAR_TYPE:"service_resume"}),h=Object.freeze({PORT:/(\d+\/\d+\/\d+)\s*$/,DATE:/^(\w{3}\s+\d{1,2}\s+\d{4}\s+\d{1,2}:\d{2})/,BR_TAG:/<br\s*\/?>/gi,HTML_TAG:/<[^>]+>/g}),k="<p><br></p>";function x(t){return t.replace(h.BR_TAG,`
`).replace(h.HTML_TAG,"").split(`
`).map(e=>e.trim()).filter(Boolean)}function j(t){if(!t.includes(`alarmID=${g.ALARM_ID}`))return null;const r=t.includes(`clearType=${g.CLEAR_TYPE}`),s=t.match(h.PORT),i=s?s[1]:null;if(!i)return null;const n=t.match(h.DATE);let c=null;if(n){const l=new Date(n[1]);isNaN(l.getTime())||(c=l.getTime())}return{state:r?"UP":"DOWN",port:i,timestamp:c,date:c?new Date(c).toISOString():null,raw:t}}function y(t,e){const a=Array.isArray(t==null?void 0:t.result)?t.result:[],r={};let s=0;for(const n of a){const c=n==null?void 0:n.output;if(!c||c===k)continue;const l=x(c);for(const C of l){const u=j(C);u&&(r[u.port]||(r[u.port]=[]),r[u.port].push(u),s++)}}for(const n of Object.keys(r))r[n].sort((c,l)=>(l.timestamp||0)-(c.timestamp||0));const i=Object.values(r).some(n=>{var c;return!n||n.length===0?!1:((c=n[0])==null?void 0:c.state)==="DOWN"});return{routerId:e.id,routerName:e.name,ports:r,totalEvents:s,affectedPorts:Object.keys(r).length,hasIssues:i,lastUpdated:Date.now()}}async function D(){const t=await chrome.storage.local.get(Object.keys(T)),e={};for(const[a,r]of Object.entries(T))t[a]===void 0&&(e[a]=r);Object.keys(e).length>0&&await chrome.storage.local.set(e)}async function G(){const t=await chrome.storage.local.get(null);return{schedulerEnabled:t[o.SCHEDULER_ENABLED]??!1,schedulerFrequency:t[o.SCHEDULER_FREQUENCY]??60,schedulerStartTime:t.schedulerStartTime??null,sessionId:t[o.SESSION_ID],routerData:t[o.ROUTER_DATA]??{},lastCheck:t[o.LAST_CHECK],authState:t[o.AUTH_STATE]??"unknown",routers:S}}async function z(t,e){const a={[o.SCHEDULER_ENABLED]:t,[o.SCHEDULER_FREQUENCY]:e,schedulerStartTime:t?Date.now():null};return await chrome.storage.local.set(a),await chrome.alarms.clear(w),t&&e&&await chrome.alarms.create(w,{periodInMinutes:e,delayInMinutes:e}),{success:!0,schedulerStartTime:a.schedulerStartTime}}async function B(t){return await chrome.storage.local.set({[o.SESSION_ID]:t}),{success:!0}}async function v(t){const e=t?"logged_in":"logged_out";return await chrome.storage.local.set({[o.AUTH_STATE]:e}),t||await chrome.storage.local.set({[o.SESSION_ID]:null}),{success:!0,authState:e}}async function H(t,e){const{[o.ROUTER_DATA]:a}=await chrome.storage.local.get(o.ROUTER_DATA);return a!=null&&a[t]&&(a[t].lastSeenState=e,await chrome.storage.local.set({[o.ROUTER_DATA]:a})),{success:!0}}async function I(){return await chrome.alarms.clearAll(),await chrome.storage.local.clear(),await D(),{success:!0}}async function F(){try{const e=(await chrome.cookies.getAll({domain:"nocportal.telekom.rs"})).find(a=>a.name==="session_id");if(e!=null&&e.value)return await chrome.storage.local.set({[o.SESSION_ID]:e.value}),e.value}catch{}return null}async function L(){let{[o.SESSION_ID]:t}=await chrome.storage.local.get(o.SESSION_ID);return t||(t=await F()),t}function b(t,e){if(!(t!=null&&t.ports)||!(e!=null&&e.ports))return Object.keys((e==null?void 0:e.ports)||{}).length>0;const a=t.ports,r=e.ports;for(const s of Object.keys(r))if(!a[s]||r[s].length>a[s].length)return!0;return!1}async function W(t,e){const{[o.ROUTER_DATA]:a={}}=await chrome.storage.local.get(o.ROUTER_DATA),r=a[t];return(r==null?void 0:r.lastSeenState)==="seen"&&!b(r,e)&&(e.lastSeenState="seen"),a[t]=e,await chrome.storage.local.set({[o.ROUTER_DATA]:a,[o.LAST_CHECK]:Date.now()}),a}async function N(){const t=await L();if(!t)return{error:"No session - open NOC Portal first"};for(const a of S){await chrome.storage.local.set({scanningRouter:a.name});let{[o.ROUTER_DATA]:r={}}=await chrome.storage.local.get(o.ROUTER_DATA);try{const s=await O(a,t),i=y(s,a),n=r[a.id];(n==null?void 0:n.lastSeenState)==="seen"&&!b(n,i)&&(i.lastSeenState="seen"),r[a.id]=i}catch(s){r[a.id]={error:s.message}}await chrome.storage.local.set({[o.ROUTER_DATA]:r,[o.LAST_CHECK]:Date.now()})}await chrome.storage.local.remove("scanningRouter");const{[o.ROUTER_DATA]:e={}}=await chrome.storage.local.get(o.ROUTER_DATA);return{success:!0,results:e}}async function Y(t){const e=await L();if(!e)return{error:"No session - open NOC Portal first"};const a=S.find(r=>r.id===t);if(!a)return{error:"Router not found"};try{const r=await O(a,e),s=y(r,a);return await W(a.id,s),{success:!0,result:s}}catch(r){return{error:r.message}}}chrome.runtime.onInstalled.addListener(async()=>{await D(),await chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}),await $()});async function $(){await chrome.contextMenus.removeAll();const{[o.SIDE_PANEL_MODE]:t}=await chrome.storage.sync.get(o.SIDE_PANEL_MODE);chrome.contextMenus.create({id:d.GLOBAL_MODE,title:"Global mode",type:"checkbox",checked:t||!1,contexts:["action"]}),chrome.contextMenus.create({id:d.SEPARATOR,type:"separator",contexts:["action"]}),chrome.contextMenus.create({id:d.REBOOT,title:"Reboot extension",type:"normal",contexts:["action"]})}chrome.contextMenus.onClicked.addListener(async t=>{t.menuItemId===d.GLOBAL_MODE?(await chrome.storage.sync.set({[o.SIDE_PANEL_MODE]:t.checked}),await P()):t.menuItemId===d.REBOOT&&await I()});chrome.alarms.onAlarm.addListener(async t=>{t.name===w&&await N()});async function M(t,e){const{[o.SIDE_PANEL_MODE]:a}=await chrome.storage.sync.get(o.SIDE_PANEL_MODE);try{await chrome.sidePanel.setOptions({tabId:t,path:"app/index.html",enabled:a||e})}catch{}}async function P(){const{[o.SIDE_PANEL_MODE]:t}=await chrome.storage.sync.get(o.SIDE_PANEL_MODE),e=await chrome.tabs.query({url:`${E}/*`}),a=new Set(e.map(s=>s.id)),r=await chrome.tabs.query({});for(const s of r)if(s.id)try{await chrome.sidePanel.setOptions({tabId:s.id,path:"app/index.html",enabled:t||a.has(s.id)})}catch{}}chrome.tabs.onActivated.addListener(async t=>{var e;try{const r=((e=(await chrome.tabs.get(t.tabId)).url)==null?void 0:e.startsWith(E))||!1;await M(t.tabId,r)}catch{}});chrome.tabs.onUpdated.addListener(async(t,e)=>{if(e.url){const a=e.url.startsWith(E);await M(t,a)}});chrome.runtime.onMessage.addListener((t,e,a)=>(Z(t).then(a),!0));async function Z(t){switch(t.action){case"getState":return G();case"setScheduler":return z(t.enabled,t.frequency);case"fetchAll":return N();case"fetchRouter":return Y(t.routerId);case"reboot":return I();case"sessionDetected":return B(t.sessionId);case"authStateChanged":return v(t.isLoggedIn);case"updateRouterSeen":return H(t.routerId,t.lastSeenState);case"setGlobalMode":return await chrome.storage.sync.set({[o.SIDE_PANEL_MODE]:t.globalMode}),await P(),{success:!0};case"getGlobalMode":return{globalMode:(await chrome.storage.sync.get(o.SIDE_PANEL_MODE))[o.SIDE_PANEL_MODE]||!1};default:return{error:"Unknown action"}}}
