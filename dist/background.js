import{C as O,b as D,L as h,U as A,c as p,S as o,A as T,R}from"./assets/routers-DMJUDeQ2.js";const m=Object.freeze({GLOBAL_MODE:"global-mode",SEPARATOR:"separator",REBOOT:"reboot-extension"}),_=Object.freeze({CALL_BUTTON:"/web/dataset/call_button",READ_WIZARD:"/web/dataset/call_kw/mts.router.switch.command.wizard/read",CREATE_WIZARD:"/web/dataset/call_kw/mts.router.switch.command.wizard/create"}),f=()=>Math.floor(Math.random()*1e9),k=t=>({bin_size:!0,lang:h.LANG,tz:h.TZ,uid:D,allowed_company_ids:[...O],full_width:!0,default_mts_router_switch_id:parseInt(t.id,10),default_mts_router_switch_name:t.name});async function S(t,e,r){const s=await(await fetch(`${A}${t}`,{method:"POST",headers:{"Content-Type":"application/json",Cookie:`session_id=${r}`},body:JSON.stringify(e),credentials:"include"})).json();if(s.error)throw new Error(s.error.message||"API Error");return s}async function I(t,e){const r=k(t),a={jsonrpc:"2.0",method:"call",params:{args:[{mts_router_switch_id:parseInt(t.id,10),interface:"GigabitEthernet"}],model:"mts.router.switch.command.wizard",method:"create",kwargs:{context:r}},id:f()},n=(await S(_.CREATE_WIZARD,a,e)).result;if(!n)throw new Error("Failed to create wizard");const u={jsonrpc:"2.0",method:"call",params:{args:[[n]],model:"mts.router.switch.command.wizard",method:"action_log",kwargs:{context:{lang:h.LANG,tz:h.TZ,uid:D,allowed_company_ids:[...O],full_width:!0,active_model:"mts.router.switch.command.wizard",active_id:n,active_ids:[n]}}},id:f()};await S(_.CALL_BUTTON,u,e);const c={jsonrpc:"2.0",method:"call",params:{args:[[n],["mts_router_switch_id","interface","output"]],model:"mts.router.switch.command.wizard",method:"read",kwargs:{context:r}},id:f()};return S(_.READ_WIZARD,c,e)}const w=Object.freeze({DOWN_ALARM_IDS:["0x0813005b","0x081300a8","0x0813007c","0x09110000"],FAILURE_ALARM_IDS:["0x08130059"],CLEAR_TYPE:"service_resume"}),E=Object.freeze({PORT:/(\d+\/\d+\/\d+(?:\.\d+)?)\s*$/,DATE:/^(\w{3}\s+\d{1,2}\s+\d{4}\s+\d{1,2}:\d{2})/,BR_TAG:/<br\s*\/?>/gi,HTML_TAG:/<[^>]+>/g}),v="<p><br></p>";function g(t){const[e,r]=t.split("."),[a,s,n]=e.split("/").map(Number);return{slot:a,card:s,portNum:n,vlan:r?Number(r):null}}function j(t,e){const r=g(t),a=g(e),s=r.vlan!==null,n=a.vlan!==null;return s!==n?s?1:-1:r.slot!==a.slot?r.slot-a.slot:r.card!==a.card?r.card-a.card:r.portNum!==a.portNum?r.portNum-a.portNum:s&&n?r.vlan-a.vlan:0}function B(t){return t.replace(E.BR_TAG,`
`).replace(E.HTML_TAG,"").split(`
`).map(e=>e.trim()).filter(Boolean)}function G(t){const e=w.DOWN_ALARM_IDS.some(l=>t.includes(`alarmID=${l}`)),r=w.FAILURE_ALARM_IDS.some(l=>t.includes(`alarmID=${l}`));if(!e&&!r)return null;const a=t.includes(`clearType=${w.CLEAR_TYPE}`);let s;e?s=a?"UP":"DOWN":s=a?"RESUME":"FAILURE";const n=t.match(E.PORT),u=n?n[1]:null;if(!u)return null;const c=t.match(E.DATE);let i=null;if(c){const l=new Date(c[1]);isNaN(l.getTime())||(i=l.getTime())}return{state:s,port:u,timestamp:i,date:i?new Date(i).toISOString():null,raw:t}}function y(t,e){const r=Array.isArray(t==null?void 0:t.result)?t.result:[],a={};let s=0;for(const c of r){const i=c==null?void 0:c.output;if(!i||i===v)continue;const l=B(i);for(const x of l){const d=G(x);d&&(a[d.port]||(a[d.port]=[]),a[d.port].push(d),s++)}}for(const c of Object.keys(a))a[c].sort((i,l)=>(l.timestamp||0)-(i.timestamp||0));const n=Object.values(a).some(c=>{var l;if(!c||c.length===0)return!1;const i=(l=c[0])==null?void 0:l.state;return i==="DOWN"||i==="FAILURE"}),u=Object.keys(a).sort(j).reduce((c,i)=>(c[i]=a[i],c),{});return{routerId:e.id,routerName:e.name,ports:u,totalEvents:s,affectedPorts:Object.keys(u).length,hasIssues:n,lastUpdated:Date.now()}}async function L(){const t=await chrome.storage.local.get(Object.keys(p)),e={};for(const[r,a]of Object.entries(p))t[r]===void 0&&(e[r]=a);Object.keys(e).length>0&&await chrome.storage.local.set(e)}async function z(){const t=await chrome.storage.local.get(null);return{schedulerEnabled:t[o.SCHEDULER_ENABLED]??!1,schedulerFrequency:t[o.SCHEDULER_FREQUENCY]??60,schedulerStartTime:t.schedulerStartTime??null,sessionId:t[o.SESSION_ID],routerData:t[o.ROUTER_DATA]??{},lastCheck:t[o.LAST_CHECK],authState:t[o.AUTH_STATE]??"unknown",routers:R}}async function F(t,e){const r={[o.SCHEDULER_ENABLED]:t,[o.SCHEDULER_FREQUENCY]:e,schedulerStartTime:t?Date.now():null};return await chrome.storage.local.set(r),await chrome.alarms.clear(T),t&&e&&await chrome.alarms.create(T,{periodInMinutes:e,delayInMinutes:e}),{success:!0,schedulerStartTime:r.schedulerStartTime}}async function H(t){return await chrome.storage.local.set({[o.SESSION_ID]:t}),{success:!0}}async function W(t){const e=t?"logged_in":"logged_out";return await chrome.storage.local.set({[o.AUTH_STATE]:e}),t||await chrome.storage.local.set({[o.SESSION_ID]:null}),{success:!0,authState:e}}async function $(t,e){const{[o.ROUTER_DATA]:r}=await chrome.storage.local.get(o.ROUTER_DATA);return r!=null&&r[t]&&(r[t].lastSeenState=e,await chrome.storage.local.set({[o.ROUTER_DATA]:r})),{success:!0}}async function b(){return await chrome.alarms.clearAll(),await chrome.storage.local.clear(),await L(),{success:!0}}async function Y(){try{const e=(await chrome.cookies.getAll({domain:"nocportal.telekom.rs"})).find(r=>r.name==="session_id");if(e!=null&&e.value)return await chrome.storage.local.set({[o.SESSION_ID]:e.value}),e.value}catch{}return null}async function N(){let{[o.SESSION_ID]:t}=await chrome.storage.local.get(o.SESSION_ID);return t||(t=await Y()),t}function M(t,e){if(!(t!=null&&t.ports)||!(e!=null&&e.ports))return Object.keys((e==null?void 0:e.ports)||{}).length>0;const r=t.ports,a=e.ports;for(const s of Object.keys(a))if(!r[s]||a[s].length>r[s].length)return!0;return!1}async function K(t,e){const{[o.ROUTER_DATA]:r={}}=await chrome.storage.local.get(o.ROUTER_DATA),a=r[t];return(a==null?void 0:a.lastSeenState)==="seen"&&!M(a,e)&&(e.lastSeenState="seen"),r[t]=e,await chrome.storage.local.set({[o.ROUTER_DATA]:r,[o.LAST_CHECK]:Date.now()}),r}async function P(){const t=await N();if(!t)return{error:"No session - open NOC Portal first"};for(const r of R){await chrome.storage.local.set({scanningRouter:r.name});const{[o.ROUTER_DATA]:a={}}=await chrome.storage.local.get(o.ROUTER_DATA),s=a[r.id];let n;try{const c=await I(r,t);n=y(c,r),(s==null?void 0:s.lastSeenState)==="seen"&&!M(s,n)&&(n.lastSeenState="seen")}catch(c){n={error:c.message}}const{[o.ROUTER_DATA]:u={}}=await chrome.storage.local.get(o.ROUTER_DATA);u[r.id]=n,await chrome.storage.local.set({[o.ROUTER_DATA]:u,[o.LAST_CHECK]:Date.now()})}await chrome.storage.local.remove("scanningRouter");const{[o.ROUTER_DATA]:e={}}=await chrome.storage.local.get(o.ROUTER_DATA);return{success:!0,results:e}}async function Z(t){const e=await N();if(!e)return{error:"No session - open NOC Portal first"};const r=R.find(a=>a.id===t);if(!r)return{error:"Router not found"};try{const a=await I(r,e),s=y(a,r);return await K(r.id,s),{success:!0,result:s}}catch(a){return{error:a.message}}}chrome.runtime.onInstalled.addListener(async()=>{await L(),await chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}),await q()});async function q(){await chrome.contextMenus.removeAll();const{[o.SIDE_PANEL_MODE]:t}=await chrome.storage.sync.get(o.SIDE_PANEL_MODE);chrome.contextMenus.create({id:m.GLOBAL_MODE,title:"Global mode",type:"checkbox",checked:t||!1,contexts:["action"]}),chrome.contextMenus.create({id:m.SEPARATOR,type:"separator",contexts:["action"]}),chrome.contextMenus.create({id:m.REBOOT,title:"Reboot extension",type:"normal",contexts:["action"]})}chrome.contextMenus.onClicked.addListener(async t=>{t.menuItemId===m.GLOBAL_MODE?(await chrome.storage.sync.set({[o.SIDE_PANEL_MODE]:t.checked}),await C()):t.menuItemId===m.REBOOT&&await b()});chrome.alarms.onAlarm.addListener(async t=>{t.name===T&&await P()});async function U(t,e){const{[o.SIDE_PANEL_MODE]:r}=await chrome.storage.sync.get(o.SIDE_PANEL_MODE);try{await chrome.sidePanel.setOptions({tabId:t,path:"app/index.html",enabled:r||e})}catch{}}async function C(){const{[o.SIDE_PANEL_MODE]:t}=await chrome.storage.sync.get(o.SIDE_PANEL_MODE),e=await chrome.tabs.query({url:`${A}/*`}),r=new Set(e.map(s=>s.id)),a=await chrome.tabs.query({});for(const s of a)if(s.id)try{await chrome.sidePanel.setOptions({tabId:s.id,path:"app/index.html",enabled:t||r.has(s.id)})}catch{}}chrome.tabs.onActivated.addListener(async t=>{var e;try{const a=((e=(await chrome.tabs.get(t.tabId)).url)==null?void 0:e.startsWith(A))||!1;await U(t.tabId,a)}catch{}});chrome.tabs.onUpdated.addListener(async(t,e)=>{if(e.url){const r=e.url.startsWith(A);await U(t,r)}});chrome.runtime.onMessage.addListener((t,e,r)=>(Q(t).then(r),!0));async function Q(t){switch(t.action){case"getState":return z();case"setScheduler":return F(t.enabled,t.frequency);case"fetchAll":return P();case"fetchRouter":return Z(t.routerId);case"reboot":return b();case"sessionDetected":return H(t.sessionId);case"authStateChanged":return W(t.isLoggedIn);case"updateRouterSeen":return $(t.routerId,t.lastSeenState);case"setGlobalMode":return await chrome.storage.sync.set({[o.SIDE_PANEL_MODE]:t.globalMode}),await C(),{success:!0};case"getGlobalMode":return{globalMode:(await chrome.storage.sync.get(o.SIDE_PANEL_MODE))[o.SIDE_PANEL_MODE]||!1};default:return{error:"Unknown action"}}}
