import{C as O,b as p,L as h,U as A,c as g,S as r,A as T,R}from"./assets/routers-DMJUDeQ2.js";const m=Object.freeze({GLOBAL_MODE:"global-mode",SEPARATOR:"separator",REBOOT:"reboot-extension"}),_=Object.freeze({CALL_BUTTON:"/web/dataset/call_button",READ_WIZARD:"/web/dataset/call_kw/mts.router.switch.command.wizard/read",CREATE_WIZARD:"/web/dataset/call_kw/mts.router.switch.command.wizard/create"}),f=()=>Math.floor(Math.random()*1e9),C=t=>({bin_size:!0,lang:h.LANG,tz:h.TZ,uid:p,allowed_company_ids:[...O],full_width:!0,default_mts_router_switch_id:parseInt(t.id,10),default_mts_router_switch_name:t.name});async function S(t,e,a){const s=await(await fetch(`${A}${t}`,{method:"POST",headers:{"Content-Type":"application/json",Cookie:`session_id=${a}`},body:JSON.stringify(e),credentials:"include"})).json();if(s.error)throw new Error(s.error.message||"API Error");return s}async function D(t,e){const a=C(t),o={jsonrpc:"2.0",method:"call",params:{args:[{mts_router_switch_id:parseInt(t.id,10),interface:"GigabitEthernet"}],model:"mts.router.switch.command.wizard",method:"create",kwargs:{context:a}},id:f()},i=(await S(_.CREATE_WIZARD,o,e)).result;if(!i)throw new Error("Failed to create wizard");const n={jsonrpc:"2.0",method:"call",params:{args:[[i]],model:"mts.router.switch.command.wizard",method:"action_log",kwargs:{context:{lang:h.LANG,tz:h.TZ,uid:p,allowed_company_ids:[...O],full_width:!0,active_model:"mts.router.switch.command.wizard",active_id:i,active_ids:[i]}}},id:f()};await S(_.CALL_BUTTON,n,e);const c={jsonrpc:"2.0",method:"call",params:{args:[[i],["mts_router_switch_id","interface","output"]],model:"mts.router.switch.command.wizard",method:"read",kwargs:{context:a}},id:f()};return S(_.READ_WIZARD,c,e)}const w=Object.freeze({DOWN_ALARM_IDS:["0x0813005b","0x081300a8","0x80fa0003"],FAILURE_ALARM_IDS:["0x08130059"],CLEAR_TYPE:"service_resume"}),E=Object.freeze({PORT:/(\d+\/\d+\/\d+)\s*$/,DATE:/^(\w{3}\s+\d{1,2}\s+\d{4}\s+\d{1,2}:\d{2})/,BR_TAG:/<br\s*\/?>/gi,HTML_TAG:/<[^>]+>/g}),k="<p><br></p>";function x(t){return t.replace(E.BR_TAG,`
`).replace(E.HTML_TAG,"").split(`
`).map(e=>e.trim()).filter(Boolean)}function j(t){const e=w.DOWN_ALARM_IDS.some(u=>t.includes(`alarmID=${u}`)),a=w.FAILURE_ALARM_IDS.some(u=>t.includes(`alarmID=${u}`));if(!e&&!a)return null;const o=t.includes(`clearType=${w.CLEAR_TYPE}`);let s;e?s=o?"UP":"DOWN":s=o?"RESUME":"FAILURE";const i=t.match(E.PORT),n=i?i[1]:null;if(!n)return null;const c=t.match(E.DATE);let l=null;if(c){const u=new Date(c[1]);isNaN(u.getTime())||(l=u.getTime())}return{state:s,port:n,timestamp:l,date:l?new Date(l).toISOString():null,raw:t}}function I(t,e){const a=Array.isArray(t==null?void 0:t.result)?t.result:[],o={};let s=0;for(const n of a){const c=n==null?void 0:n.output;if(!c||c===k)continue;const l=x(c);for(const u of l){const d=j(u);d&&(o[d.port]||(o[d.port]=[]),o[d.port].push(d),s++)}}for(const n of Object.keys(o))o[n].sort((c,l)=>(l.timestamp||0)-(c.timestamp||0));const i=Object.values(o).some(n=>{var l;if(!n||n.length===0)return!1;const c=(l=n[0])==null?void 0:l.state;return c==="DOWN"||c==="FAILURE"});return{routerId:e.id,routerName:e.name,ports:o,totalEvents:s,affectedPorts:Object.keys(o).length,hasIssues:i,lastUpdated:Date.now()}}async function L(){const t=await chrome.storage.local.get(Object.keys(g)),e={};for(const[a,o]of Object.entries(g))t[a]===void 0&&(e[a]=o);Object.keys(e).length>0&&await chrome.storage.local.set(e)}async function G(){const t=await chrome.storage.local.get(null);return{schedulerEnabled:t[r.SCHEDULER_ENABLED]??!1,schedulerFrequency:t[r.SCHEDULER_FREQUENCY]??60,schedulerStartTime:t.schedulerStartTime??null,sessionId:t[r.SESSION_ID],routerData:t[r.ROUTER_DATA]??{},lastCheck:t[r.LAST_CHECK],authState:t[r.AUTH_STATE]??"unknown",routers:R}}async function z(t,e){const a={[r.SCHEDULER_ENABLED]:t,[r.SCHEDULER_FREQUENCY]:e,schedulerStartTime:t?Date.now():null};return await chrome.storage.local.set(a),await chrome.alarms.clear(T),t&&e&&await chrome.alarms.create(T,{periodInMinutes:e,delayInMinutes:e}),{success:!0,schedulerStartTime:a.schedulerStartTime}}async function B(t){return await chrome.storage.local.set({[r.SESSION_ID]:t}),{success:!0}}async function v(t){const e=t?"logged_in":"logged_out";return await chrome.storage.local.set({[r.AUTH_STATE]:e}),t||await chrome.storage.local.set({[r.SESSION_ID]:null}),{success:!0,authState:e}}async function F(t,e){const{[r.ROUTER_DATA]:a}=await chrome.storage.local.get(r.ROUTER_DATA);return a!=null&&a[t]&&(a[t].lastSeenState=e,await chrome.storage.local.set({[r.ROUTER_DATA]:a})),{success:!0}}async function y(){return await chrome.alarms.clearAll(),await chrome.storage.local.clear(),await L(),{success:!0}}async function H(){try{const e=(await chrome.cookies.getAll({domain:"nocportal.telekom.rs"})).find(a=>a.name==="session_id");if(e!=null&&e.value)return await chrome.storage.local.set({[r.SESSION_ID]:e.value}),e.value}catch{}return null}async function b(){let{[r.SESSION_ID]:t}=await chrome.storage.local.get(r.SESSION_ID);return t||(t=await H()),t}function N(t,e){if(!(t!=null&&t.ports)||!(e!=null&&e.ports))return Object.keys((e==null?void 0:e.ports)||{}).length>0;const a=t.ports,o=e.ports;for(const s of Object.keys(o))if(!a[s]||o[s].length>a[s].length)return!0;return!1}async function W(t,e){const{[r.ROUTER_DATA]:a={}}=await chrome.storage.local.get(r.ROUTER_DATA),o=a[t];return(o==null?void 0:o.lastSeenState)==="seen"&&!N(o,e)&&(e.lastSeenState="seen"),a[t]=e,await chrome.storage.local.set({[r.ROUTER_DATA]:a,[r.LAST_CHECK]:Date.now()}),a}async function M(){const t=await b();if(!t)return{error:"No session - open NOC Portal first"};for(const a of R){await chrome.storage.local.set({scanningRouter:a.name});const{[r.ROUTER_DATA]:o={}}=await chrome.storage.local.get(r.ROUTER_DATA),s=o[a.id];let i;try{const c=await D(a,t);i=I(c,a),(s==null?void 0:s.lastSeenState)==="seen"&&!N(s,i)&&(i.lastSeenState="seen")}catch(c){i={error:c.message}}const{[r.ROUTER_DATA]:n={}}=await chrome.storage.local.get(r.ROUTER_DATA);n[a.id]=i,await chrome.storage.local.set({[r.ROUTER_DATA]:n,[r.LAST_CHECK]:Date.now()})}await chrome.storage.local.remove("scanningRouter");const{[r.ROUTER_DATA]:e={}}=await chrome.storage.local.get(r.ROUTER_DATA);return{success:!0,results:e}}async function $(t){const e=await b();if(!e)return{error:"No session - open NOC Portal first"};const a=R.find(o=>o.id===t);if(!a)return{error:"Router not found"};try{const o=await D(a,e),s=I(o,a);return await W(a.id,s),{success:!0,result:s}}catch(o){return{error:o.message}}}chrome.runtime.onInstalled.addListener(async()=>{await L(),await chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}),await Y()});async function Y(){await chrome.contextMenus.removeAll();const{[r.SIDE_PANEL_MODE]:t}=await chrome.storage.sync.get(r.SIDE_PANEL_MODE);chrome.contextMenus.create({id:m.GLOBAL_MODE,title:"Global mode",type:"checkbox",checked:t||!1,contexts:["action"]}),chrome.contextMenus.create({id:m.SEPARATOR,type:"separator",contexts:["action"]}),chrome.contextMenus.create({id:m.REBOOT,title:"Reboot extension",type:"normal",contexts:["action"]})}chrome.contextMenus.onClicked.addListener(async t=>{t.menuItemId===m.GLOBAL_MODE?(await chrome.storage.sync.set({[r.SIDE_PANEL_MODE]:t.checked}),await U()):t.menuItemId===m.REBOOT&&await y()});chrome.alarms.onAlarm.addListener(async t=>{t.name===T&&await M()});async function P(t,e){const{[r.SIDE_PANEL_MODE]:a}=await chrome.storage.sync.get(r.SIDE_PANEL_MODE);try{await chrome.sidePanel.setOptions({tabId:t,path:"app/index.html",enabled:a||e})}catch{}}async function U(){const{[r.SIDE_PANEL_MODE]:t}=await chrome.storage.sync.get(r.SIDE_PANEL_MODE),e=await chrome.tabs.query({url:`${A}/*`}),a=new Set(e.map(s=>s.id)),o=await chrome.tabs.query({});for(const s of o)if(s.id)try{await chrome.sidePanel.setOptions({tabId:s.id,path:"app/index.html",enabled:t||a.has(s.id)})}catch{}}chrome.tabs.onActivated.addListener(async t=>{var e;try{const o=((e=(await chrome.tabs.get(t.tabId)).url)==null?void 0:e.startsWith(A))||!1;await P(t.tabId,o)}catch{}});chrome.tabs.onUpdated.addListener(async(t,e)=>{if(e.url){const a=e.url.startsWith(A);await P(t,a)}});chrome.runtime.onMessage.addListener((t,e,a)=>(Z(t).then(a),!0));async function Z(t){switch(t.action){case"getState":return G();case"setScheduler":return z(t.enabled,t.frequency);case"fetchAll":return M();case"fetchRouter":return $(t.routerId);case"reboot":return y();case"sessionDetected":return B(t.sessionId);case"authStateChanged":return v(t.isLoggedIn);case"updateRouterSeen":return F(t.routerId,t.lastSeenState);case"setGlobalMode":return await chrome.storage.sync.set({[r.SIDE_PANEL_MODE]:t.globalMode}),await U(),{success:!0};case"getGlobalMode":return{globalMode:(await chrome.storage.sync.get(r.SIDE_PANEL_MODE))[r.SIDE_PANEL_MODE]||!1};default:return{error:"Unknown action"}}}
