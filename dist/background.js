import{C as R,a as D,L as m,U as E,b as T,S as r,A as S,R as f}from"./assets/routers-80mQZLFW.js";const d=Object.freeze({GLOBAL_MODE:"global-mode",SEPARATOR:"separator",REBOOT:"reboot-extension"}),_=Object.freeze({CALL_BUTTON:"/web/dataset/call_button",READ_WIZARD:"/web/dataset/call_kw/mts.router.switch.command.wizard/read",CREATE_WIZARD:"/web/dataset/call_kw/mts.router.switch.command.wizard/create"}),A=()=>Math.floor(Math.random()*1e9),C=t=>({bin_size:!0,lang:m.LANG,tz:m.TZ,uid:D,allowed_company_ids:[...R],full_width:!0,default_mts_router_switch_id:parseInt(t.id,10),default_mts_router_switch_name:t.name});async function w(t,e,a){const s=await(await fetch(`${E}${t}`,{method:"POST",headers:{"Content-Type":"application/json",Cookie:`session_id=${a}`},body:JSON.stringify(e),credentials:"include"})).json();if(s.error)throw new Error(s.error.message||"API Error");return s}async function p(t,e){const a=C(t),o={jsonrpc:"2.0",method:"call",params:{args:[{mts_router_switch_id:parseInt(t.id,10),interface:"GigabitEthernet"}],model:"mts.router.switch.command.wizard",method:"create",kwargs:{context:a}},id:A()},n=(await w(_.CREATE_WIZARD,o,e)).result;if(!n)throw new Error("Failed to create wizard");const i={jsonrpc:"2.0",method:"call",params:{args:[[n]],model:"mts.router.switch.command.wizard",method:"action_log",kwargs:{context:{lang:m.LANG,tz:m.TZ,uid:D,allowed_company_ids:[...R],full_width:!0,active_model:"mts.router.switch.command.wizard",active_id:n,active_ids:[n]}}},id:A()};await w(_.CALL_BUTTON,i,e);const c={jsonrpc:"2.0",method:"call",params:{args:[[n],["mts_router_switch_id","interface","output"]],model:"mts.router.switch.command.wizard",method:"read",kwargs:{context:a}},id:A()};return w(_.READ_WIZARD,c,e)}const g=Object.freeze({ALARM_ID:"0x0813005b",CLEAR_TYPE:"service_resume"}),h=Object.freeze({PORT:/(\d+\/\d+\/\d+)\s*$/,DATE:/^(\w{3}\s+\d{1,2}\s+\d{4}\s+\d{1,2}:\d{2})/,BR_TAG:/<br\s*\/?>/gi,HTML_TAG:/<[^>]+>/g}),U="<p><br></p>";function k(t){return t.replace(h.BR_TAG,`
`).replace(h.HTML_TAG,"").split(`
`).map(e=>e.trim()).filter(Boolean)}function x(t){if(!t.includes(`alarmID=${g.ALARM_ID}`))return null;const o=t.includes(`clearType=${g.CLEAR_TYPE}`),s=t.match(h.PORT),n=s?s[1]:null;if(!n)return null;const i=t.match(h.DATE);let c=null;if(i){const l=new Date(i[1]);isNaN(l.getTime())||(c=l.getTime())}return{state:o?"UP":"DOWN",port:n,timestamp:c,date:c?new Date(c).toISOString():null,raw:t}}function O(t,e){const a=Array.isArray(t==null?void 0:t.result)?t.result:[],o={};let s=0,n=!1;for(const i of a){const c=i==null?void 0:i.output;if(!c||c===U)continue;const l=k(c);for(const P of l){const u=x(P);u&&(o[u.port]||(o[u.port]=[]),o[u.port].push(u),s++,u.state==="DOWN"&&(n=!0))}}for(const i of Object.keys(o))o[i].sort((c,l)=>(l.timestamp||0)-(c.timestamp||0));return{routerId:e.id,routerName:e.name,ports:o,totalEvents:s,affectedPorts:Object.keys(o).length,hasIssues:n,lastUpdated:Date.now()}}async function y(){const t=await chrome.storage.local.get(Object.keys(T)),e={};for(const[a,o]of Object.entries(T))t[a]===void 0&&(e[a]=o);Object.keys(e).length>0&&await chrome.storage.local.set(e)}async function G(){const t=await chrome.storage.local.get(null);return{schedulerEnabled:t[r.SCHEDULER_ENABLED]??!1,schedulerFrequency:t[r.SCHEDULER_FREQUENCY]??60,schedulerStartTime:t.schedulerStartTime??null,sessionId:t[r.SESSION_ID],routerData:t[r.ROUTER_DATA]??{},lastCheck:t[r.LAST_CHECK],authState:t[r.AUTH_STATE]??"unknown",routers:f}}async function z(t,e){const a={[r.SCHEDULER_ENABLED]:t,[r.SCHEDULER_FREQUENCY]:e,schedulerStartTime:t?Date.now():null};return await chrome.storage.local.set(a),await chrome.alarms.clear(S),t&&e&&await chrome.alarms.create(S,{periodInMinutes:e,delayInMinutes:e}),{success:!0,schedulerStartTime:a.schedulerStartTime}}async function B(t){return await chrome.storage.local.set({[r.SESSION_ID]:t}),{success:!0}}async function j(t){const e=t?"logged_in":"logged_out";return await chrome.storage.local.set({[r.AUTH_STATE]:e}),t||await chrome.storage.local.set({[r.SESSION_ID]:null}),{success:!0,authState:e}}async function v(t,e){const{[r.ROUTER_DATA]:a}=await chrome.storage.local.get(r.ROUTER_DATA);return a!=null&&a[t]&&(a[t].lastSeenState=e,await chrome.storage.local.set({[r.ROUTER_DATA]:a})),{success:!0}}async function I(){return await chrome.alarms.clearAll(),await chrome.storage.local.clear(),await y(),{success:!0}}async function H(){try{const e=(await chrome.cookies.getAll({domain:"nocportal.telekom.rs"})).find(a=>a.name==="session_id");if(e!=null&&e.value)return await chrome.storage.local.set({[r.SESSION_ID]:e.value}),e.value}catch{}return null}async function L(){let{[r.SESSION_ID]:t}=await chrome.storage.local.get(r.SESSION_ID);return t||(t=await H()),t}async function F(t,e){const{[r.ROUTER_DATA]:a={}}=await chrome.storage.local.get(r.ROUTER_DATA);return a[t]=e,await chrome.storage.local.set({[r.ROUTER_DATA]:a,[r.LAST_CHECK]:Date.now()}),a}async function b(){var a;const t=await L();if(!t)return{error:"No session - open NOC Portal first"};let{[r.ROUTER_DATA]:e={}}=await chrome.storage.local.get(r.ROUTER_DATA);for(const o of f){await chrome.storage.local.set({scanningRouter:o.name});try{const s=await p(o,t),n=O(s,o);(a=e[o.id])!=null&&a.lastSeenState&&(n.lastSeenState=e[o.id].lastSeenState),e[o.id]=n}catch(s){e[o.id]={error:s.message}}await chrome.storage.local.set({[r.ROUTER_DATA]:e,[r.LAST_CHECK]:Date.now()})}return await chrome.storage.local.remove("scanningRouter"),{success:!0,results:e}}async function W(t){const e=await L();if(!e)return{error:"No session - open NOC Portal first"};const a=f.find(o=>o.id===t);if(!a)return{error:"Router not found"};try{const o=await p(a,e),s=O(o,a);return await F(a.id,s),{success:!0,result:s}}catch(o){return{error:o.message}}}chrome.runtime.onInstalled.addListener(async()=>{await y(),await chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}),await Y()});async function Y(){await chrome.contextMenus.removeAll();const{[r.SIDE_PANEL_MODE]:t}=await chrome.storage.sync.get(r.SIDE_PANEL_MODE);chrome.contextMenus.create({id:d.GLOBAL_MODE,title:"Global mode",type:"checkbox",checked:t||!1,contexts:["action"]}),chrome.contextMenus.create({id:d.SEPARATOR,type:"separator",contexts:["action"]}),chrome.contextMenus.create({id:d.REBOOT,title:"Reboot extension",type:"normal",contexts:["action"]})}chrome.contextMenus.onClicked.addListener(async t=>{t.menuItemId===d.GLOBAL_MODE?(await chrome.storage.sync.set({[r.SIDE_PANEL_MODE]:t.checked}),await M()):t.menuItemId===d.REBOOT&&await I()});chrome.alarms.onAlarm.addListener(async t=>{t.name===S&&await b()});async function N(t,e){const{[r.SIDE_PANEL_MODE]:a}=await chrome.storage.sync.get(r.SIDE_PANEL_MODE);try{await chrome.sidePanel.setOptions({tabId:t,path:"app/index.html",enabled:a||e})}catch{}}async function M(){const{[r.SIDE_PANEL_MODE]:t}=await chrome.storage.sync.get(r.SIDE_PANEL_MODE),e=await chrome.tabs.query({url:`${E}/*`}),a=new Set(e.map(s=>s.id)),o=await chrome.tabs.query({});for(const s of o)if(s.id)try{await chrome.sidePanel.setOptions({tabId:s.id,path:"app/index.html",enabled:t||a.has(s.id)})}catch{}}chrome.tabs.onActivated.addListener(async t=>{var e;try{const o=((e=(await chrome.tabs.get(t.tabId)).url)==null?void 0:e.startsWith(E))||!1;await N(t.tabId,o)}catch{}});chrome.tabs.onUpdated.addListener(async(t,e)=>{if(e.url){const a=e.url.startsWith(E);await N(t,a)}});chrome.runtime.onMessage.addListener((t,e,a)=>($(t).then(a),!0));async function $(t){switch(t.action){case"getState":return G();case"setScheduler":return z(t.enabled,t.frequency);case"fetchAll":return b();case"fetchRouter":return W(t.routerId);case"reboot":return I();case"sessionDetected":return B(t.sessionId);case"authStateChanged":return j(t.isLoggedIn);case"updateRouterSeen":return v(t.routerId,t.lastSeenState);case"setGlobalMode":return await chrome.storage.sync.set({[r.SIDE_PANEL_MODE]:t.globalMode}),await M(),{success:!0};case"getGlobalMode":return{globalMode:(await chrome.storage.sync.get(r.SIDE_PANEL_MODE))[r.SIDE_PANEL_MODE]||!1};default:return{error:"Unknown action"}}}
